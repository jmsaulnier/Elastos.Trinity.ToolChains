#!/usr/bin/env python3

import os
import sys
import zipfile
import argparse

parser = argparse.ArgumentParser(description='Create an EPK file for Elastos DApp.')
parser.add_argument('epk_file', metavar='EPK_FILE',
                    help='specify the EPK file to be created')
parser.add_argument('-m', '--manifest', dest='manifest_file', metavar='FILE', required=True,
                    help='specify the manifest file for the DApp')
parser.add_argument('-r', '--root-dir', dest='root_dir', metavar='DIR', required=True,
                    help='specify the root directory of the DApp')

args = parser.parse_args()

try:
    zipf = zipfile.ZipFile(args.epk_file, 'w', zipfile.ZIP_DEFLATED)

    if args.root_dir:
        if not os.path.isdir(args.root_dir):
            print("Error: The ROOT_DIR is not a directory.")
            exit()

        for root, subdirs, files in os.walk(args.root_dir):
            for file in files:
                fullpath = os.path.join(root, file)
                relpath = os.path.relpath(fullpath, args.root_dir)
                zipf.write(fullpath, relpath)

    if args.manifest_file:
        if not os.path.isfile(args.manifest_file):
            print("Error: The MANIFEST_FILE is not a file.")
            exit()

        zipf.write(args.manifest_file, 'manifest.json')

    zipf.close()
except:
    print("Unexpected error:", sys.exc_info()[0])
    exit()

